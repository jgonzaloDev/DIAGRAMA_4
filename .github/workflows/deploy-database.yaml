name: Deploy Database to Azure SQL Server

on:
  workflow_dispatch:  # EjecuciÃ³n manual
  push:
    branches:
      - main
    paths:
      - 'database/**'  # Solo si cambian archivos de BD

jobs:
  validate-scripts:
    name: Validate SQL Scripts
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate SQL Syntax
        run: |
          echo "ğŸ” Validando archivos SQL..."
          
          if [ ! -d "database/migrations" ]; then
            echo "âŒ Error: No existe database/migrations"
            exit 1
          fi
          
          echo "ğŸ“„ Scripts de migraciÃ³n:"
          ls -lh database/migrations/*.sql 2>/dev/null || echo "âš ï¸  Sin scripts de migraciÃ³n"
          
          echo ""
          echo "ğŸ“„ Scripts de seeds:"
          ls -lh database/seeds/*.sql 2>/dev/null || echo "âš ï¸  Sin seeds"

      - name: Upload SQL Scripts Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-scripts
          path: database/
          retention-days: 30

  deploy-migrations:
    name: Deploy to Azure SQL Database
    runs-on: ubuntu-latest
    needs: validate-scripts
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download SQL Scripts Artifact
        uses: actions/download-artifact@v4
        with:
          name: sql-scripts
          path: database

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install SQL Server Tools
        run: |
          echo "ğŸ“¦ Instalando SQL Server Tools..."
          
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          
          echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH
          
          echo "âœ… SQL Server Tools instalado"

      - name: Get SQL Server FQDN
        id: sql-config
        run: |
          echo "ğŸ” Obteniendo configuraciÃ³n de SQL Server..."
          
          # Obtener FQDN del SQL Server desde Azure
          SQL_SERVER=$(az sql server show \
            --name ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --query fullyQualifiedDomainName -o tsv)
          
          # Usar credenciales desde GitHub Secrets
          DB_NAME="${{ secrets.TF_VAR_SQL_DATABASE_NAME }}"
          DB_USER="${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }}"
          DB_PASSWORD="${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }}"
          
          # Enmascarar password en logs
          echo "::add-mask::$DB_PASSWORD"
          
          # Exportar como outputs
          echo "DB_NAME=$DB_NAME" >> $GITHUB_OUTPUT
          echo "DB_USER=$DB_USER" >> $GITHUB_OUTPUT
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_OUTPUT
          echo "SQL_SERVER=$SQL_SERVER" >> $GITHUB_OUTPUT
          
          echo "âœ… ConfiguraciÃ³n obtenida"
          echo "   Database: $DB_NAME"
          echo "   Server: $SQL_SERVER"
          echo "   User: $DB_USER"

      - name: Configure SQL Server Firewall
        id: firewall
        run: |
          echo "ğŸ”¥ Configurando firewall temporal..."
          
          # Obtener IP pÃºblica del runner
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          
          # Crear regla temporal de firewall
          RULE_NAME="GitHubActions-$(date +%s)"
          
          az sql server firewall-rule create \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --name "$RULE_NAME" \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP
          
          echo "FIREWALL_RULE=$RULE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Regla de firewall creada: $RULE_NAME"

      - name: Execute Database Migrations
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸš€ Ejecutando migraciones..."
          
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          # Ejecutar scripts en orden
          for SQL_FILE in $(ls database/migrations/*.sql 2>/dev/null | sort); do
            if [ -f "$SQL_FILE" ]; then
              SCRIPT_NAME=$(basename "$SQL_FILE")
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“„ Ejecutando: $SCRIPT_NAME"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              if sqlcmd -S "$SQL_SERVER" \
                        -d "$DB_NAME" \
                        -U "$DB_USER" \
                        -P "$DB_PASSWORD" \
                        -C \
                        -i "$SQL_FILE" \
                        -o "${SCRIPT_NAME}.log" 2>&1; then
                
                echo "âœ… $SCRIPT_NAME ejecutado exitosamente"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                cat "${SCRIPT_NAME}.log"
              else
                echo "âŒ Error ejecutando $SCRIPT_NAME"
                cat "${SCRIPT_NAME}.log"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                exit 1
              fi
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Resumen de Migraciones"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Exitosas: $SUCCESS_COUNT"
          echo "âŒ Fallidas: $FAILED_COUNT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Execute Database Seeds
        if: github.ref != 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸŒ± Ejecutando seeds..."
          
          if [ ! -d "database/seeds" ] || [ -z "$(ls -A database/seeds/*.sql 2>/dev/null)" ]; then
            echo "âš ï¸  No hay seeds para ejecutar"
            exit 0
          fi
          
          for SQL_FILE in $(ls database/seeds/*.sql 2>/dev/null | sort); do
            if [ -f "$SQL_FILE" ]; then
              SCRIPT_NAME=$(basename "$SQL_FILE")
              echo ""
              echo "ğŸ“„ Ejecutando seed: $SCRIPT_NAME"
              
              sqlcmd -S "$SQL_SERVER" \
                      -d "$DB_NAME" \
                      -U "$DB_USER" \
                      -P "$DB_PASSWORD" \
                      -C \
                      -i "$SQL_FILE" \
                      -o "${SCRIPT_NAME}.log"
              
              if [ $? -eq 0 ]; then
                echo "âœ… $SCRIPT_NAME ejecutado"
                cat "${SCRIPT_NAME}.log"
              else
                echo "âš ï¸  Error en $SCRIPT_NAME (no crÃ­tico)"
                cat "${SCRIPT_NAME}.log"
              fi
            fi
          done

      - name: Verify Database State
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸ” Verificando estado de la base de datos..."
          
          echo ""
          echo "ğŸ“Š Tablas en la base de datos:"
          sqlcmd -S "$SQL_SERVER" \
                  -d "$DB_NAME" \
                  -U "$DB_USER" \
                  -P "$DB_PASSWORD" \
                  -C \
                  -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME;" \
                  -h -1
          
          echo ""
          echo "ğŸ“ˆ Conteo de registros:"
          sqlcmd -S "$SQL_SERVER" \
                  -d "$DB_NAME" \
                  -U "$DB_USER" \
                  -P "$DB_PASSWORD" \
                  -C \
                  -Q "
                    SELECT 'customers' as tabla, COUNT(*) as registros FROM dbo.customers
                    UNION ALL
                    SELECT 'orders', COUNT(*) FROM dbo.orders
                    UNION ALL
                    SELECT 'order_items', COUNT(*) FROM dbo.order_items
                    UNION ALL
                    SELECT 'migrations', COUNT(*) FROM dbo.migrations;
                  " \
                  -h -1

      - name: Remove Firewall Rule
        if: always()
        run: |
          echo "ğŸ§¹ Eliminando regla temporal de firewall..."
          
          az sql server firewall-rule list \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --query "[?contains(name, 'GitHubActions')].name" -o tsv | \
          while read RULE_NAME; do
            echo "Eliminando: $RULE_NAME"
            az sql server firewall-rule delete \
              --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
              --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
              --name "$RULE_NAME" || true
          done
          
          echo "âœ… Firewall limpiado"

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ RESUMEN DEL DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Entorno: ${{ github.ref_name == 'main' && 'PRODUCCIÃ“N' || 'DESARROLLO' }}"
          echo "ğŸ—„ï¸  Database: ${{ steps.sql-config.outputs.DB_NAME }}"
          echo "ğŸ–¥ï¸  Server: ${{ steps.sql-config.outputs.SQL_SERVER }}"
          echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
          echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Azure Logout
        if: always()
        run: az logout || true
